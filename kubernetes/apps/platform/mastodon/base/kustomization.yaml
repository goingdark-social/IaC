apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mastodon

configMapGenerator:
  - name: mastodon-core-env
    literals:
      - RAILS_ENV=production
      - NODE_ENV=production
      - TZ=Europe/Stockholm
      - SINGLE_USER_MODE=false
      - MASTODON_USE_LIBVIPS=true
      - RAILS_LOG_TO_STDOUT=true
      - PREPARED_STATEMENTS=false

  - name: mastodon-db-env
    literals:
      - DB_HOST=mastodon-postgresql-pooler
      - DB_PORT=5432
      - DB_NAME=mastodon
      - DB_SSLMODE=require
      - DB_SSLROOTCERT=/opt/mastodon/.postgresql/root.crt
      - DB_POOL=15
      - REPLICA_DB_HOST=mastodon-postgresql-repl
      - REPLICA_DB_PORT=5432
      - REPLICA_DB_NAME=mastodon
      - REPLICA_PREPARED_STATEMENTS=false
      - REPLICA_DB_TASKS=false
      - DATABASE_TIMEOUT=60
      - STREAMING_DATABASE_TIMEOUT=10

  - name: mastodon-cache-env
    envs:
      - configs/cache.env

  - name: mastodon-search-env
    envs:
      - configs/search.env

  - name: mastodon-metrics-env
    envs:
      - configs/metrics.env

  - name: mastodon-features-env
    envs:
      - configs/features.env

  - name: mastodon-network-env
    envs:
      - configs/network.env

  - name: mastodon-storage-env
    envs:
      - configs/storage.env

  - name: mastodon-smtp-env
    envs:
      - configs/smtp.env

resources:
  - namespace.yaml
  - secretstore.yaml
  - serviceaccount.yaml
  - externalsecret.yaml
