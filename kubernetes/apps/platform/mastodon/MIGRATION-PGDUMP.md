# Migrating Zalando Postgres Operator to CloudNativePG Using pg_dump

This document describes the production migration strategy for moving the Mastodon PostgreSQL database from Zalando Postgres Operator to CloudNativePG using logical backups (pg_dump/pg_restore). This approach is preferred for production environments as it provides fine-grained control, repeatability, and operates without blocking production traffic during the initial import.

## Why pg_dump/pg_restore?

**Non-blocking exports**: pg_dump creates consistent exports without blocking readers or writers. You can take the initial backup while the production application continues to operate.

**Portable logical backups**: Dumps can be restored on any PostgreSQL version supported by CloudNativePG. pg_dump produces a custom-format archive that can be restored in parallel for speed.

**Fine-grained control**: CloudNativePG's import feature exposes `pgDumpExtraOptions` and `pgRestoreExtraOptions` fields, allowing you to tune the commands for optimal performance.

**Proven safety**: Logical backups are well-tested and provide clear verification points before and after migration.

## Migration Strategy Overview

This migration uses CloudNativePG's built-in `bootstrap.initdb.import` feature to automatically:
1. Run pg_dump against the source Zalando cluster
2. Transfer the dump to the new cluster
3. Restore it using pg_restore with parallel jobs

The process has two phases:

### Phase 1: Initial Import (Zero Downtime)
- Deploy CloudNativePG cluster with import configuration
- CNPG automatically runs pg_dump from the Zalando cluster
- Production continues running on Zalando cluster
- Verify import completed successfully

### Phase 2: Final Cutover (Short Maintenance Window)
- Scale down Mastodon workloads (planned maintenance)
- Take final incremental dump of any changes (optional, for safety)
- Switch application to CloudNativePG cluster
- Verify and scale up workloads
- Resume production

## Prerequisites

- [x] CloudNativePG operator installed (`kubernetes/apps/database/cloudnative-pg/`)
- [x] Zalando Postgres Operator cluster running (`mastodon-postgresql`)
- [x] ExternalSecret configured for standby credentials (`zalando-standby-credentials`)
- [x] TLS certificates configured (`mastodon-postgresql-ca`, `mastodon-postgresql-server`)
- [x] kubectl and kubectl-cnpg plugin installed
- [ ] Standby user privileges verified (see below)
- [ ] Database version compatibility confirmed (PostgreSQL 17 on both)
- [ ] Sufficient disk space confirmed on source and target
- [ ] Staging/test run completed (highly recommended)
- [ ] Maintenance window scheduled (estimated 15-30 minutes)
- [ ] Backup of Zalando cluster verified and tested

## Pre-Migration Verification

### 0. Automated Preflight Checks

**Run the automated preflight script** to verify all prerequisites at once:

```bash
./scripts/cnpg-migration-preflight.sh
```

This script automatically validates:
- ✅ kubectl and kubectl-cnpg plugin installed
- ✅ Cluster connectivity
- ✅ Mastodon namespace exists
- ✅ Zalando cluster running
- ✅ Standby credentials secret exists
- ✅ TLS certificates configured
- ✅ CloudNativePG operator installed
- ✅ Database size and available disk space
- ✅ PostgreSQL connectivity test
- ✅ Standby user privileges
- ✅ PostgreSQL version compatibility

If all checks pass, proceed with manual verification steps below. If any checks fail, resolve them before continuing.

### 1. Verify Standby User Credentials and Privileges

The ExternalSecret automatically syncs the standby user credentials from the Zalando cluster:

```bash
# Verify the ExternalSecret is healthy
kubectl get externalsecret zalando-standby-credentials -n mastodon

# Check the generated secret exists
kubectl get secret zalando-standby-credentials -n mastodon

# Verify the credentials (optional)
kubectl get secret zalando-standby-credentials -n mastodon \
  -o jsonpath='{.data.username}' | base64 -d
echo
kubectl get secret zalando-standby-credentials -n mastodon \
  -o jsonpath='{.data.password}' | base64 -d
echo
```

Expected output:
- Username: `standby`
- Password: (auto-generated by Zalando operator)

#### 1.1 Verify Standby User Privileges

The `standby` user must have sufficient privileges to export all database objects. Verify privileges:

```bash
# Check if standby user has superuser or required read roles
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres -c "
    SELECT 
      rolname,
      rolsuper,
      rolreplication,
      pg_has_role(rolname, 'pg_read_all_data', 'member') as has_read_all_data,
      pg_has_role(rolname, 'pg_read_all_settings', 'member') as has_read_all_settings
    FROM pg_roles 
    WHERE rolname = 'standby';
  "
```

**Expected result**: The `standby` user should have:
- `rolsuper = t` (superuser), OR
- `rolreplication = t` AND `has_read_all_data = t`

**If privileges are insufficient**, create a dedicated dump user:

```bash
# Create read-only dump user with required privileges
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres mastodon << 'EOF'
-- Create dump user if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'pgdump_user') THEN
    CREATE ROLE pgdump_user WITH LOGIN PASSWORD 'SECURE_PASSWORD_HERE';
  END IF;
END
$$;

-- Grant read privileges
GRANT pg_read_all_data TO pgdump_user;
GRANT pg_read_all_settings TO pgdump_user;
GRANT CONNECT ON DATABASE mastodon TO pgdump_user;
GRANT USAGE ON SCHEMA public TO pgdump_user;

-- Allow reading sequences (needed for pg_dump)
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO pgdump_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON SEQUENCES TO pgdump_user;
EOF
```

**If using a custom dump user**, update the ExternalSecret or create a new secret:

```bash
kubectl create secret generic cnpg-dump-credentials -n mastodon \
  --from-literal=username=pgdump_user \
  --from-literal=password=SECURE_PASSWORD_HERE \
  --dry-run=client -o yaml | kubectl apply -f -
```

Then update `database-cnpg.yaml` to reference `cnpg-dump-credentials` instead of `zalando-standby-credentials`.

**Note**: The Zalando-generated `standby` user typically has replication privileges which include sufficient read access. Verify first before creating a new user.

### 2. Test Connection from CloudNativePG Namespace

Before deploying, verify network connectivity and credentials:

```bash
# Get standby password
STANDBY_PASS=$(kubectl get secret zalando-standby-credentials -n mastodon -o jsonpath='{.data.password}' | base64 -d)

# Create a test pod to verify connectivity
kubectl run -n mastodon pg-test --rm -it --restart=Never \
  --image=ghcr.io/cloudnative-pg/postgresql:17.5 \
  -- bash -c "
    export PGPASSWORD=\"$STANDBY_PASS\"
    psql 'host=mastodon-postgresql.mastodon.svc.cluster.local port=5432 user=standby dbname=mastodon sslmode=verify-ca' \
      -c 'SELECT version();' \
      -c '\l' \
      -c '\du'
  "
```

**Alternative using environment variables**:
```bash
kubectl run -n mastodon pg-test --rm -it --restart=Never \
  --image=ghcr.io/cloudnative-pg/postgresql:17.5 \
  --env="PGPASSWORD=$STANDBY_PASS" \
  --env="PGSSLMODE=verify-ca" \
  -- bash -c "
    psql -h mastodon-postgresql.mastodon.svc.cluster.local \
         -p 5432 \
         -U standby \
         -d mastodon \
         -c 'SELECT version();' \
         -c '\l' \
         -c '\du'
  "
```

Expected output:
- PostgreSQL version string (should be 17.x)
- List of databases (should include `mastodon`)
- List of roles (should include `standby` and `mastodon`)

**If connection fails**, troubleshoot:
- Network policies blocking traffic
- Incorrect credentials in ExternalSecret
- TLS certificate issues (check if CA cert is accessible)
- Service DNS resolution (`nslookup mastodon-postgresql.mastodon.svc.cluster.local`)
- Firewall rules blocking PostgreSQL port 5432

### 3. Check Current Database Size and Disk Space

Estimate import time based on database size and verify sufficient disk space:

```bash
# Check database size
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres -c "
    SELECT 
      pg_database.datname,
      pg_size_pretty(pg_database_size(pg_database.datname)) AS size,
      pg_database_size(pg_database.datname) AS size_bytes
    FROM pg_database
    WHERE datname = 'mastodon';
  "

# Check available disk space on source
kubectl exec -n mastodon mastodon-postgresql-0 -- df -h /home/postgres/pgdata

# Check available disk space on target (after CNPG pod starts)
# kubectl exec -n mastodon database-cnpg-1 -- df -h /var/lib/postgresql/data
```

**Import time estimates**:
- < 10 GB: 5-15 minutes
- 10-50 GB: 15-45 minutes
- 50-100 GB: 45-90 minutes
- > 100 GB: 1.5-3 hours

**Disk space requirements**:
- **Source**: No additional space needed (pg_dump streams directly)
- **Target**: At least 2x the database size for:
  - Imported data
  - WAL files
  - Temporary pg_restore working space
  - Future growth

**If disk space is insufficient**, increase PVC sizes in `database-cnpg.yaml`:
```yaml
storage:
  size: 80Gi  # Increase from 40Gi
walStorage:
  size: 20Gi  # Increase from 10Gi
```

### 4. Verify Database Roles to Import

Check which roles exist on the source and should be migrated:

```bash
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres -c "
    SELECT 
      rolname,
      rolsuper,
      rolinherit,
      rolcreaterole,
      rolcreatedb,
      rolcanlogin,
      rolreplication
    FROM pg_roles
    WHERE rolname NOT LIKE 'pg_%'
      AND rolname != 'postgres'
    ORDER BY rolname;
  "
```

**Typical Mastodon roles**:
- `mastodon` - Application user
- `standby` - Replication user (created by Zalando)
- Any custom admin or monitoring users

**Update `database-cnpg.yaml` if needed**:
```yaml
bootstrap:
  initdb:
    import:
      roles:
        - mastodon
        # - other_role_name  # Add any additional roles here
```

**Note**: 
- The `standby` role is typically not needed in CNPG (CNPG creates its own replication users)
- Superuser roles won't be imported (PostgreSQL security restriction)
- Password hashes will be imported but may need to be reset

### 5. Verify PostgreSQL Version Compatibility

Confirm both clusters are running compatible PostgreSQL versions:

```bash
# Check source version
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres -c "SELECT version();"

# After CNPG deployment, check target version
# kubectl cnpg psql database-cnpg -n mastodon -- -c "SELECT version();"
```

**Expected**: Both should be PostgreSQL 17.x (confirmed in manifests)

**Compatibility notes**:
- ✅ Same major version (17 → 17): Fully compatible
- ✅ Minor version differences (17.4 → 17.5): Safe
- ⚠️  Major version upgrade (16 → 17): Requires additional testing
- ❌ Downgrade (17 → 16): Not supported

### 6. Staging Environment Test (Highly Recommended)

If possible, perform a dry-run in a staging environment:

```bash
# Create a test namespace
kubectl create namespace mastodon-staging

# Copy secrets to staging namespace
kubectl get secret -n mastodon zalando-standby-credentials -o yaml | \
  sed 's/namespace: mastodon/namespace: mastodon-staging/' | \
  kubectl apply -f -

kubectl get secret -n mastodon mastodon-postgresql-ca -o yaml | \
  sed 's/namespace: mastodon/namespace: mastodon-staging/' | \
  kubectl apply -f -

kubectl get secret -n mastodon mastodon-postgresql-server -o yaml | \
  sed 's/namespace: mastodon/namespace: mastodon-staging/' | \
  kubectl apply -f -

# Copy and modify the database-cnpg.yaml for staging
cp kubernetes/apps/platform/mastodon/resources/workloads/database-cnpg.yaml /tmp/database-cnpg-staging.yaml

# Update namespace in the staging manifest
sed -i 's/namespace: mastodon/namespace: mastodon-staging/g' /tmp/database-cnpg-staging.yaml

# Deploy CNPG cluster to staging (points to production Zalando for import)
kubectl apply -f /tmp/database-cnpg-staging.yaml

# Monitor the staging import
kubectl logs -n mastodon-staging -l cnpg.io/cluster=database-cnpg -f

# Measure import time
START_TIME=$(date +%s)
kubectl wait --for=condition=ready pod -l cnpg.io/cluster=database-cnpg -n mastodon-staging --timeout=120m
END_TIME=$(date +%s)
echo "Import took $(($END_TIME - $START_TIME)) seconds"

# Verify data in staging
kubectl cnpg psql database-cnpg -n mastodon-staging -- -c "SELECT COUNT(*) FROM pg_tables WHERE schemaname = 'public';"

# Clean up staging after verification
kubectl delete namespace mastodon-staging
```

**Benefits of staging test**:
- ✅ Accurate import time measurement for production planning
- ✅ Verify pg_dump privileges are sufficient
- ✅ Test application compatibility with CNPG (optional: deploy test Mastodon)
- ✅ Identify any migration issues before production cutover
- ✅ Practice rollback procedures
- ✅ Validate network connectivity and TLS configuration
- ✅ Confirm disk space requirements

**Note**: The staging import reads from the production Zalando cluster without blocking it. This is a true production-like test.

## Phase 1: Initial Import (Zero Downtime)

### Understanding the Configuration

The CloudNativePG cluster requires two key configuration sections for import:

#### 1. Bootstrap Import Configuration

Tells CNPG to use pg_dump/pg_restore for initial data import:

```yaml
bootstrap:
  initdb:
    import:
      type: monolith
      databases:
        - mastodon
      roles:
        - mastodon
      source:
        externalCluster: zalando-cluster
      pgDumpExtraOptions:
        - "--verbose"
        - "--format=custom"
        - "--no-owner"
        - "--no-acl"
      pgRestoreExtraOptions:
        - "--verbose"
        - "--jobs=4"
        - "--no-owner"
        - "--no-acl"
```

#### 2. External Cluster Definition

Tells CNPG how to connect to the source Zalando cluster:

```yaml
externalClusters:
  - name: zalando-cluster
    connectionParameters:
      host: mastodon-postgresql.mastodon.svc.cluster.local
      port: "5432"
      user: standby
      dbname: mastodon
      sslmode: verify-ca
    password:
      name: zalando-standby-credentials
      key: password
    sslRootCert:
      name: mastodon-postgresql-ca
      key: ca.crt
```

**Critical**: The `source.externalCluster: zalando-cluster` in the bootstrap section references the `name: zalando-cluster` in `externalClusters`. This connection configuration is already present in your `database-cnpg.yaml`.

### Step 1: Deploy CloudNativePG Cluster

The cluster is configured in `kubernetes/apps/platform/mastodon/resources/workloads/database-cnpg.yaml` with both sections above.

**Verify the configuration includes**:
- ✅ `bootstrap.initdb.import` section with pg_dump options
- ✅ `externalClusters` section with Zalando connection details
- ✅ Correct secret references (`zalando-standby-credentials`, `mastodon-postgresql-ca`)
- ✅ TLS certificates configured for CNPG services

Deploy the cluster:

```bash
# From repository root
kustomize build kubernetes/apps/platform/mastodon/resources/workloads | kubectl apply -f -

# Or with ArgoCD (if auto-sync is disabled)
kubectl apply -f kubernetes/apps/platform/mastodon/resources/workloads/database-cnpg.yaml
```

### Step 2: Monitor Import Progress

Watch the cluster initialization:

```bash
# Watch pod status
kubectl get pods -n mastodon -l cnpg.io/cluster=database-cnpg -w

# Check cluster status
kubectl cnpg status database-cnpg -n mastodon

# View import logs
kubectl logs -n mastodon -l cnpg.io/cluster=database-cnpg -f
```

The import process will:
1. Create the cluster pod(s)
2. Initialize the database with `initdb`
3. Run `pg_dump` against the Zalando cluster
4. Run `pg_restore --jobs=4` to restore in parallel
5. Mark cluster as ready

**Expected log entries**:
```
INFO: Importing cluster from external cluster "zalando-cluster"
INFO: Running pg_dump with options: --verbose --format=custom --no-owner --no-acl
INFO: Dump completed successfully
INFO: Running pg_restore with options: --verbose --jobs=4 --no-owner --no-acl
INFO: Restore completed successfully
INFO: Database cluster is ready
```

### Step 3: Verify Import Completed Successfully

```bash
# Check cluster is ready
kubectl cnpg status database-cnpg -n mastodon

# Verify database and roles exist
kubectl cnpg psql database-cnpg -n mastodon -- -c "\l"
kubectl cnpg psql database-cnpg -n mastodon -- -c "\du"

# Check table counts match source
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT schemaname, COUNT(*) as table_count
  FROM pg_tables
  WHERE schemaname = 'public'
  GROUP BY schemaname;
"

# Compare with Zalando cluster
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres mastodon -c "
    SELECT schemaname, COUNT(*) as table_count
    FROM pg_tables
    WHERE schemaname = 'public'
    GROUP BY schemaname;
  "
```

### Step 4: Verify Data Integrity

Run sample queries to verify data migrated correctly:

```bash
# Check Mastodon accounts table
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT COUNT(*) FROM accounts;
"

# Check statuses table
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT COUNT(*) FROM statuses;
"

# Verify recent data (compare with source)
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT MAX(created_at) FROM statuses;
"

# Verify sequences are at correct values
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT 
    schemaname,
    sequencename,
    last_value
  FROM pg_sequences
  WHERE schemaname = 'public'
  ORDER BY sequencename
  LIMIT 10;
"

# Compare sequence values with source
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres mastodon -c "
    SELECT 
      schemaname,
      sequencename,
      last_value
    FROM pg_sequences
    WHERE schemaname = 'public'
    ORDER BY sequencename
    LIMIT 10;
  "
```

#### What Gets Imported

The `bootstrap.initdb.import` configuration with pg_dump migrates:

✅ **Database Schema**:
- Tables, columns, and data types
- Indexes (including unique, partial, expression indexes)
- Primary keys and foreign keys
- Check constraints and unique constraints
- Sequences with current values
- Views and materialized views
- Functions, procedures, and triggers
- Custom types and enums
- Comments on database objects

✅ **Data**:
- All rows from all tables
- Large objects (if any)
- TOAST data (large column values)

✅ **Roles** (specified in import config):
- Role definitions
- Password hashes (will be preserved)
- Role attributes (LOGIN, CREATEDB, etc.)

❌ **Not Imported** (due to `--no-owner --no-acl`):
- Object ownership (all objects owned by postgres initially)
- Access control lists (privileges/grants)
- Tablespace assignments
- Server configuration (postgresql.conf)
- Replication slots
- Unlogged tables (empty by design)

**Post-import actions required**:
- Object ownership will be handled by CNPG auto-generated credentials
- Application will connect using new `database-cnpg-app` user
- Privileges are set automatically by CNPG for the app user
- Original `mastodon` role imported but not used by default

#### Verify Imported Roles

```bash
# Check roles were imported
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT 
    rolname,
    rolcanlogin,
    rolcreatedb,
    rolcreaterole
  FROM pg_roles
  WHERE rolname IN ('mastodon', 'postgres')
  ORDER BY rolname;
"
```

Expected roles in CNPG cluster:
- `postgres` - Superuser (CNPG manages this)
- `mastodon` - Imported application role (password preserved)
- `streaming_replica` - Created by CNPG for replication
- `app` - Auto-generated by CNPG for application connections

**Note**: The application will use the CNPG-generated `app` user (from `database-cnpg-app` secret), not the imported `mastodon` role. This is by design for better security and management.

## Phase 2: Final Cutover (Maintenance Window)

### Pre-Cutover Checklist

- [ ] Initial import completed successfully (Phase 1)
- [ ] Data integrity verified
- [ ] Maintenance window communicated to users
- [ ] Rollback plan prepared
- [ ] Backup of Zalando cluster completed and verified

### Step 1: Announce Maintenance Window

Post on Mastodon instance:
```
🚧 Scheduled Maintenance

We'll be performing a database migration in 15 minutes. 
Expected downtime: 15-30 minutes
Timeline: [START_TIME] - [END_TIME] UTC

This will improve performance and reliability. Thanks for your patience!
```

### Step 2: Scale Down Mastodon Workloads

```bash
# Stop all Mastodon pods to prevent new writes
kubectl scale deployment -n mastodon \
  mastodon-web \
  mastodon-streaming \
  mastodon-sidekiq-default \
  mastodon-sidekiq-federation \
  mastodon-sidekiq-background \
  mastodon-sidekiq-scheduler \
  --replicas=0

# Verify all pods are terminated
kubectl get pods -n mastodon | grep mastodon
```

### Step 3: Take Final Delta Dump (Optional but Recommended)

Capture any data written between initial import and cutover:

```bash
# Get timestamp of initial import completion
IMPORT_TIMESTAMP=$(kubectl logs -n mastodon -l cnpg.io/cluster=database-cnpg \
  | grep "Restore completed" \
  | tail -1 \
  | awk '{print $1}')

# Take incremental dump of recent changes
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  pg_dump -U standby -d mastodon \
  --format=custom \
  --file=/tmp/delta-dump.dump \
  --verbose

# Copy dump to local machine for safety
kubectl cp mastodon/mastodon-postgresql-0:/tmp/delta-dump.dump ./delta-dump.dump
```

**Note**: This step is optional as the initial import should be very recent. Include it if there was significant time between import and cutover.

### Step 4: Reconfigure CloudNativePG for Production

Remove the import configuration and enable production features:

```bash
# Apply the promoted configuration
kubectl apply -f kubernetes/apps/platform/mastodon/resources/workloads/database-cnpg-promoted.yaml

# Verify cluster is healthy
kubectl cnpg status database-cnpg -n mastodon
```

The promoted configuration includes:
- Increased instances to 2 (HA)
- S3 backups enabled (scheduled backups twice weekly)
- WAL archiving to S3
- Production-ready PostgreSQL parameters

### Step 5: Update Application Configuration

#### 5.1 Get New Database Credentials

CloudNativePG auto-generates application credentials:

```bash
# Extract credentials
NEW_USER=$(kubectl get secret database-cnpg-app -n mastodon -o jsonpath='{.data.username}' | base64 -d)
NEW_PASS=$(kubectl get secret database-cnpg-app -n mastodon -o jsonpath='{.data.password}' | base64 -d)
NEW_HOST="database-cnpg-pooler-rw.mastodon.svc.cluster.local"

echo "New Database Configuration:"
echo "  Host: $NEW_HOST"
echo "  User: $NEW_USER"
echo "  Pass: $NEW_PASS"
```

#### 5.2 Update Database Credentials Secret

Mastodon deployments use `envFrom` to load `mastodon-db-url` secret with `DB_USER` and `DB_PASS` keys:

```bash
kubectl create secret generic mastodon-db-url -n mastodon \
  --from-literal=DB_USER="$NEW_USER" \
  --from-literal=DB_PASS="$NEW_PASS" \
  --dry-run=client -o yaml | kubectl apply -f -
```

#### 5.3 Update Database Host Configuration

**Option A: Update ConfigMap directly (immediate)**

```bash
kubectl patch configmap mastodon-database -n mastodon --type merge -p '{
  "data": {
    "DB_HOST": "database-cnpg-pooler-rw.mastodon.svc.cluster.local",
    "DB_PORT": "5432"
  }
}'
```

**Option B: Update source file and sync (GitOps)**

```bash
# Edit the config file
sed -i 's/DB_HOST=.*/DB_HOST=database-cnpg-pooler-rw.mastodon.svc.cluster.local/' \
  kubernetes/apps/platform/mastodon/configs/mastodon-database.env

# Commit and push
git add kubernetes/apps/platform/mastodon/configs/mastodon-database.env
git commit -m "chore: switch database to CloudNativePG pooler"
git push

# Sync with ArgoCD (if not auto-syncing)
argocd app sync platform/mastodon
```

### Step 6: Database Post-Migration Tasks

#### 6.1 Refresh Collation Version

PostgreSQL 17 may have updated collations:

```bash
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  ALTER DATABASE mastodon REFRESH COLLATION VERSION;
"
```

#### 6.2 Update Statistics (Optional)

Help the query planner with fresh statistics:

```bash
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  ANALYZE VERBOSE;
"
```

#### 6.3 Verify Indexes and Constraints

```bash
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT schemaname, tablename, indexname
  FROM pg_indexes
  WHERE schemaname = 'public'
  ORDER BY tablename, indexname
  LIMIT 20;
"
```

### Step 7: Restore Mastodon Workloads

Start with minimal replicas and scale up gradually:

```bash
# Start with 1 replica each for initial verification
kubectl scale deployment -n mastodon \
  mastodon-web --replicas=1 \
  mastodon-streaming --replicas=1 \
  mastodon-sidekiq-default --replicas=1 \
  mastodon-sidekiq-federation --replicas=1 \
  mastodon-sidekiq-background --replicas=1 \
  mastodon-sidekiq-scheduler --replicas=1

# Wait for pods to be ready
kubectl wait --for=condition=ready pod \
  -l app.kubernetes.io/name=mastodon \
  -n mastodon \
  --timeout=300s
```

### Step 8: Verify Application Health

#### 8.1 Check Pod Logs

```bash
# Web server logs
kubectl logs -n mastodon -l app=mastodon-web --tail=50

# Sidekiq logs
kubectl logs -n mastodon -l app=mastodon-sidekiq-default --tail=50

# Look for successful database connections
kubectl logs -n mastodon -l app=mastodon-web | grep -i "database\|postgres\|connected"
```

#### 8.2 Test Database Connectivity

```bash
# From web pod
kubectl exec -n mastodon deploy/mastodon-web -- \
  psql "$DATABASE_URL" -c "SELECT version();"

# Check active connections
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT count(*), usename, application_name
  FROM pg_stat_activity
  WHERE datname = 'mastodon'
  GROUP BY usename, application_name;
"
```

#### 8.3 Functional Testing

- [ ] Load homepage: `https://goingdark.social`
- [ ] Login with existing account
- [ ] Post a new status
- [ ] View home timeline
- [ ] Check notifications
- [ ] Verify federation (check federated timeline)
- [ ] Test search functionality

### Step 9: Enable HPA and Scale to Normal Load

```bash
# Scale to normal production replicas
kubectl scale deployment -n mastodon \
  mastodon-web --replicas=2 \
  mastodon-streaming --replicas=2 \
  mastodon-sidekiq-default --replicas=2 \
  mastodon-sidekiq-federation --replicas=2

# Verify HPA is controlling replicas
kubectl get hpa -n mastodon
```

### Step 10: Monitor for 1-2 Hours

Watch for any issues:

```bash
# Monitor pod health
watch kubectl get pods -n mastodon

# Monitor database connections
watch "kubectl cnpg psql database-cnpg -n mastodon -- -c 'SELECT count(*) FROM pg_stat_activity WHERE datname = \'mastodon\';'"

# Check for errors in logs
kubectl logs -n mastodon -l app=mastodon-web --since=10m | grep -i error
kubectl logs -n mastodon -l cnpg.io/cluster=database-cnpg --since=10m | grep -i error
```

## Post-Migration (After 24-48 Hours Stable Operation)

### Step 1: Verify Backup System

```bash
# Check scheduled backup is configured
kubectl get schedulebackup -n mastodon

# Trigger manual backup to verify
kubectl cnpg backup database-cnpg -n mastodon

# Verify backup in S3
kubectl cnpg backup list database-cnpg -n mastodon
```

### Step 2: Remove Zalando Resources

#### 2.1 Update Kustomization

```bash
# Remove Zalando manifest reference
cat <<EOF > kubernetes/apps/platform/mastodon/resources/workloads/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- database-cnpg.yaml  # Only CNPG now
- elastic-sts.yaml
- redis-statefulset.yaml
- sidekiq-default-deployment.yaml
- sidekiq-federation-deployment.yaml
- sidekiq-background-deployment.yaml
- sidekiq-scheduler-deployment.yaml
- streaming-deployment.yaml
- web-deployment.yaml
EOF

# Move promoted config to primary
mv kubernetes/apps/platform/mastodon/resources/workloads/database-cnpg-promoted.yaml \
   kubernetes/apps/platform/mastodon/resources/workloads/database-cnpg.yaml

# Commit changes
git add kubernetes/apps/platform/mastodon/resources/workloads/
git commit -m "chore: remove Zalando Postgres Operator resources after CNPG migration"
git push
```

#### 2.2 Archive Zalando Cluster (Optional)

```bash
# Scale down Zalando cluster (keep for 7 days as safety net)
kubectl patch postgresql mastodon-postgresql -n mastodon \
  --type merge \
  -p '{"spec":{"numberOfInstances":0}}'

# After 7 days, delete the Zalando cluster
kubectl delete postgresql mastodon-postgresql -n mastodon

# Remove Zalando operator if no other clusters exist
kubectl get postgresql --all-namespaces
# If empty:
kubectl delete -f kubernetes/apps/database/postgresql/
```

### Step 3: Update Documentation

- [ ] Update `README.md` to reference CloudNativePG
- [ ] Update architecture diagrams
- [ ] Document new backup procedures
- [ ] Update runbooks with new `kubectl cnpg` commands

## Rollback Procedure (If Issues Arise)

If problems occur during cutover:

### Immediate Rollback (Within Maintenance Window)

```bash
# 1. Scale down CNPG-connected workloads
kubectl scale deployment -n mastodon \
  mastodon-web mastodon-streaming mastodon-sidekiq-* \
  --replicas=0

# 2. Revert database configuration
kubectl patch configmap mastodon-database -n mastodon --type merge -p '{
  "data": {
    "DB_HOST": "mastodon-postgresql.mastodon.svc.cluster.local",
    "DB_PORT": "5432"
  }
}'

# 3. Restore original credentials (if changed)
kubectl get secret mastodon-db-url -n mastodon -o yaml > /tmp/cnpg-creds-backup.yaml
# Restore from backup or recreate with original values

# 4. Scale up with original config
kubectl scale deployment -n mastodon \
  mastodon-web --replicas=2 \
  mastodon-streaming --replicas=2 \
  mastodon-sidekiq-default --replicas=1 \
  mastodon-sidekiq-federation --replicas=1 \
  mastodon-sidekiq-background --replicas=1 \
  mastodon-sidekiq-scheduler --replicas=1

# 5. Verify application works with Zalando cluster
```

### Post-Analysis

After rollback:
1. Collect logs from CloudNativePG cluster
2. Review any errors encountered
3. Update migration plan based on findings
4. Schedule new maintenance window when issues resolved

## Troubleshooting

### Import Fails with Permission Denied

**Symptoms**: pg_dump fails with "permission denied" or "must be superuser"

**Cause**: The `standby` user lacks sufficient privileges to read all database objects.

**Solution**:
```bash
# Check current privileges
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres -c "
    SELECT 
      rolname,
      rolsuper,
      pg_has_role(rolname, 'pg_read_all_data', 'member') as has_read_all_data
    FROM pg_roles 
    WHERE rolname = 'standby';
  "

# If standby lacks privileges, grant them:
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres -c "
    GRANT pg_read_all_data TO standby;
    GRANT pg_read_all_settings TO standby;
  "

# Or create a dedicated dump user (see Pre-Migration Verification section)
```

### Import Fails or Takes Too Long

**Symptoms**: pg_dump/pg_restore fails or hangs

**Solutions**:
```bash
# Check network connectivity
kubectl exec -n mastodon database-cnpg-1 -- \
  nc -zv mastodon-postgresql.mastodon.svc.cluster.local 5432

# Check credentials
kubectl get secret zalando-standby-credentials -n mastodon -o yaml

# Check source database health
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres -c "SELECT pg_is_in_recovery();"

# View detailed import logs
kubectl logs -n mastodon -l cnpg.io/cluster=database-cnpg --tail=200

# Check for disk space issues on target
kubectl exec -n mastodon database-cnpg-1 -- df -h /var/lib/postgresql/data
```

### Missing Tables or Data After Import

**Symptoms**: Some tables or data missing in CNPG cluster

**Possible causes**:
1. Import only specified databases (check `databases:` list in config)
2. Insufficient privileges for standby user
3. Import partially failed (check logs for errors)

**Solutions**:
```bash
# List all databases on source
kubectl exec -n mastodon mastodon-postgresql-0 -- \
  psql -U postgres -l

# Verify database specified in import config matches
# Check logs for partial import errors
kubectl logs -n mastodon -l cnpg.io/cluster=database-cnpg | grep -i error

# If needed, delete cluster and re-import:
kubectl delete cluster database-cnpg -n mastodon
# Wait for PVCs to be deleted
kubectl apply -f kubernetes/apps/platform/mastodon/resources/workloads/database-cnpg.yaml
```

### Application Cannot Connect to New Database

**Symptoms**: Connection errors in application logs

**Checklist**:
- [ ] ConfigMap updated with correct `DB_HOST`
- [ ] Secret contains correct `DB_USER` and `DB_PASS`
- [ ] Pooler pods are running: `kubectl get pods -n mastodon -l cnpg.io/poolerName=database-cnpg-pooler-rw`
- [ ] Network policies allow traffic
- [ ] TLS certificates are valid

**Debug commands**:
```bash
# Test connection from application pod
kubectl exec -n mastodon deploy/mastodon-web -- \
  psql "host=database-cnpg-pooler-rw.mastodon.svc.cluster.local port=5432 dbname=mastodon user=mastodon sslmode=require" \
  -c "SELECT version();"

# Check pooler logs
kubectl logs -n mastodon -l cnpg.io/poolerName=database-cnpg-pooler-rw

# Verify service endpoints
kubectl get endpoints -n mastodon database-cnpg-pooler-rw
```

### Performance Degradation After Migration

**Symptoms**: Slow queries, high latency

**Actions**:
```bash
# Update statistics
kubectl cnpg psql database-cnpg -n mastodon -- -c "ANALYZE VERBOSE;"

# Check for missing indexes
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT schemaname, tablename, indexname
  FROM pg_indexes
  WHERE schemaname = 'public'
  ORDER BY tablename;
"

# Review slow queries
kubectl cnpg psql database-cnpg -n mastodon -- -c "
  SELECT query, mean_exec_time, calls
  FROM pg_stat_statements
  ORDER BY mean_exec_time DESC
  LIMIT 10;
"

# Check connection pooling
kubectl get pooler -n mastodon database-cnpg-pooler-rw -o yaml
```

## Monitoring and Alerting

### Key Metrics to Watch

**During Import**:
- Cluster pod status and restarts
- Import log messages
- Network I/O between clusters
- Source database load

**After Cutover**:
- Application pod health
- Database connection count
- Query latency (p95, p99)
- Backup success rate
- Replication lag (if using replicas)

### VictoriaMetrics Queries

```promql
# Database connections
sum(cnpg_backends_total{namespace="mastodon"}) by (datname)

# Replication lag
cnpg_pg_replication_lag{namespace="mastodon"}

# Backup age
time() - cnpg_pg_backup_last_successful_time{namespace="mastodon"}

# Query rate
rate(cnpg_pg_stat_database_xact_commit{namespace="mastodon"}[5m])
```

## Success Criteria

Migration is considered successful when:

- [x] CloudNativePG cluster is healthy and running
- [x] All Mastodon tables and data migrated
- [x] Application pods are healthy and processing requests
- [x] Users can login, post, and federate normally
- [x] No database-related errors in logs
- [x] Automated backups are working
- [x] Performance metrics are normal or improved
- [x] No data loss confirmed via spot checks
- [x] 24+ hours of stable operation

## Timeline Summary

| Phase | Duration | Downtime |
|-------|----------|----------|
| Pre-migration verification | 30 min | No |
| Initial import (Phase 1) | 15-90 min* | No |
| Maintenance window prep | 15 min | No |
| Cutover (Phase 2) | 15-30 min | Yes |
| Post-cutover monitoring | 1-2 hours | No |
| Full stabilization | 24-48 hours | No |

*Depends on database size

**Total Downtime**: 15-30 minutes

## References

- [CloudNativePG Import Documentation](https://cloudnative-pg.io/documentation/current/bootstrap/#import-existing-databases)
- [PostgreSQL pg_dump Documentation](https://www.postgresql.org/docs/current/app-pgdump.html)
- [PostgreSQL pg_restore Documentation](https://www.postgresql.org/docs/current/app-pgrestore.html)
- [Zalando Postgres Operator](https://github.com/zalando/postgres-operator)
- [Mastodon Database Requirements](https://docs.joinmastodon.org/admin/prerequisites/#postgresql)

## Support

For issues during migration:
1. Check troubleshooting section above
2. Review CloudNativePG operator logs: `kubectl logs -n cnpg-system -l app.kubernetes.io/name=cloudnative-pg`
3. Consult CloudNativePG community: https://cloudnative-pg.io/community/
4. Escalate to infrastructure team with collected logs

---

**Migration prepared by**: Infrastructure Team
**Last updated**: {{ date }}
**Status**: Ready for execution
