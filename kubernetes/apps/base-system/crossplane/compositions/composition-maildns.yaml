apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: maildns-custom
  annotations:
    argocd.argoproj.io/sync-wave: "30"
  labels:
    provider: custom
spec:
  compositeTypeRef:
    apiVersion: dns.goingdark.social/v1alpha1
    kind: XMailDNS
  resources:
    - name: dns-records-job
      base:
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: dns-records-peekoff
          namespace: crossplane-system
        spec:
          ttlSecondsAfterFinished: 86400
          backoffLimit: 1
          template:
            spec:
              restartPolicy: Never
              serviceAccountName: cloudflare-dns
              containers:
                - name: curl
                  image: curlimages/curl:8.7.1
                  env:
                    - name: CF_ZONE_ID
                      valueFrom:
                        secretKeyRef:
                          name: mail-dns-secrets
                          key: zone-id
                    - name: CF_TOKEN
                      valueFrom:
                        secretKeyRef:
                          name: mail-dns-secrets
                          key: api-token
                    - name: DKIM_ED25519
                      valueFrom:
                        secretKeyRef:
                          name: mail-dns-secrets
                          key: dkim-ed25519
                    - name: DKIM_RSA
                      valueFrom:
                        secretKeyRef:
                          name: mail-dns-secrets
                          key: dkim-rsa
                  command: ["/bin/sh"]
                  args:
                    - -c
                    - |
                      set -e
                      echo "Creating DNS records for peekoff.com..."
                      # Helper function for curl calls
                      create_record() {
                        curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records" \
                          -H "Authorization: Bearer $CF_TOKEN" \
                          -H "Content-Type: application/json" \
                          -d "$1" && echo "âœ“ Created: $2"
                      }
                      # A Record - mail
                      create_record '{"type":"A","name":"mail","content":"mail.peekoff.com","ttl":300,"proxied":false,"comment":"Mail server"}' "A mail"
                      # MX Record
                      create_record '{"type":"MX","name":"@","content":"mail.peekoff.com","priority":10,"ttl":300,"proxied":false,"comment":"Mail server"}' "MX"
                      # DKIM Ed25519
                      create_record "{\"type\":\"TXT\",\"name\":\"202512e._domainkey\",\"content\":\"$DKIM_ED25519\",\"ttl\":300,\"proxied\":false,\"comment\":\"DKIM Ed25519 key\"}" "DKIM Ed25519"
                      # DKIM RSA
                      create_record "{\"type\":\"TXT\",\"name\":\"202512r._domainkey\",\"content\":\"$DKIM_RSA\",\"ttl\":300,\"proxied\":false,\"comment\":\"DKIM RSA key\"}" "DKIM RSA"
                      # SPF Records
                      create_record '{"type":"TXT","name":"mail","content":"v=spf1 a ra=postmaster -all","ttl":300,"proxied":false,"comment":"SPF for mail"}' "SPF mail"
                      create_record '{"type":"TXT","name":"@","content":"v=spf1 mx ra=postmaster -all","ttl":300,"proxied":false,"comment":"SPF for apex"}' "SPF apex"
                      # SRV Records
                      create_record "{\"type\":\"SRV\",\"name\":\"_jmap._tcp\",\"data\":{\"service\":\"_jmap\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":443,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"JMAP SRV\"}" "SRV JMAP"
                      create_record "{\"type\":\"SRV\",\"name\":\"_caldavs._tcp\",\"data\":{\"service\":\"_caldavs\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":443,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"CalDAV SRV\"}" "SRV CalDAV"
                      create_record "{\"type\":\"SRV\",\"name\":\"_carddavs._tcp\",\"data\":{\"service\":\"_carddavs\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":443,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"CardDAV SRV\"}" "SRV CardDAV"
                      create_record "{\"type\":\"SRV\",\"name\":\"_imaps._tcp\",\"data\":{\"service\":\"_imaps\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":993,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"IMAPS SRV\"}" "SRV IMAPS"
                      create_record "{\"type\":\"SRV\",\"name\":\"_imap._tcp\",\"data\":{\"service\":\"_imap\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":143,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"IMAP SRV\"}" "SRV IMAP"
                      create_record "{\"type\":\"SRV\",\"name\":\"_pop3s._tcp\",\"data\":{\"service\":\"_pop3s\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":995,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"POP3S SRV\"}" "SRV POP3S"
                      create_record "{\"type\":\"SRV\",\"name\":\"_pop3._tcp\",\"data\":{\"service\":\"_pop3\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":110,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"POP3 SRV\"}" "SRV POP3"
                      create_record "{\"type\":\"SRV\",\"name\":\"_submissions._tcp\",\"data\":{\"service\":\"_submissions\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":465,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"Submissions SRV\"}" "SRV Submissions"
                      create_record "{\"type\":\"SRV\",\"name\":\"_submission._tcp\",\"data\":{\"service\":\"_submission\",\"proto\":\"_tcp\",\"priority\":0,\"weight\":1,\"port\":587,\"target\":\"mail.peekoff.com\"},\"ttl\":300,\"proxied\":false,\"comment\":\"Submission SRV\"}" "SRV Submission"
                      # CNAME Records
                      create_record '{"type":"CNAME","name":"autoconfig","content":"mail.peekoff.com","ttl":300,"proxied":false,"comment":"Autoconfiguration CNAME"}' "CNAME autoconfig"
                      create_record '{"type":"CNAME","name":"autodiscover","content":"mail.peekoff.com","ttl":300,"proxied":false,"comment":"Autodiscover CNAME"}' "CNAME autodiscover"
                      # DMARC TXT Record
                      create_record '{"type":"TXT","name":"_dmarc","content":"v=DMARC1; p=reject; rua=mailto:postmaster@peekoff.com; ruf=mailto:postmaster@peekoff.com","ttl":300,"proxied":false,"comment":"DMARC policy"}' "DMARC"
                      # TLS Reporting TXT Record
                      create_record '{"type":"TXT","name":"_smtp._tls","content":"v=TLSRPTv1; rua=mailto:postmaster@peekoff.com","ttl":300,"proxied":false,"comment":"TLS reporting"}' "TLS RPT"
                      echo "All DNS records created successfully!"
