apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: maildns-custom
  annotations:
    argocd.argoproj.io/sync-wave: "30"
  labels:
    provider: custom
spec:
  compositeTypeRef:
    apiVersion: dns.goingdark.social/v1alpha1
    kind: XMailDNS
  mode: Pipeline
  pipeline:
    - step: observe-lb-ips
      functionRef:
        name: function-pt
      input:
        apiVersion: fn.crossplane.io/v1beta1
        kind: RunFunctionRequest
        input:
          desired:
            status:
              loadBalancerIPv4: "{{ index .spec.services \"mail-lb\" \"status.loadBalancer.ingress\" 0 \"ip\" }}"
              loadBalancerIPv6: "{{ index .spec.services \"mail-lb\" \"status.loadBalancer.ingress\" 1 \"ip\" }}"
          resources:
            - name: mail-lb
              apiVersion: v1
              kind: Service
              namespace: stalwart
              selector:
                app: stalwart-mail
    - step: create-dns-records
      functionRef:
        name: function-pt
      input:
        apiVersion: fn.crossplane.io/v1beta1
        kind: RunFunctionRequest
        input:
          manifests:
            - apiVersion: batch/v1
              kind: Job
              metadata:
                name: dns-a-mail-{{ .spec.domain }}
                namespace: crossplane-system
              spec:
                template:
                  spec:
                    restartPolicy: Never
                    serviceAccountName: cloudflare-dns
                    containers:
                      - name: curl
                        image: curlimages/curl:8.7.1
                        env:
                          - name: CF_ZONE_ID
                            valueFrom:
                              secretKeyRef:
                                name: mail-dns-secrets
                                key: zone-id
                          - name: CF_TOKEN
                            valueFrom:
                              secretKeyRef:
                                name: mail-dns-secrets
                                key: api-token
                          - name: LOADBALANCER_IPV4
                            value: "{{ .status.loadBalancerIPv4 }}"
                        command: ["/bin/sh"]
                        args:
                          - -c
                          - |
                            curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records" \
                              -H "Authorization: Bearer $CF_TOKEN" \
                              -H "Content-Type: application/json" \
                              -d '{"type":"A","name":"mail","content":"'"${LOADBALANCER_IPV4}"'","ttl":300,"proxied":false,"comment":"Stalwart mail server"}' && echo "mail A OK"
            - apiVersion: batch/v1
              kind: Job
              metadata:
                name: dns-cname-mta-sts-{{ .spec.domain }}
                namespace: crossplane-system
              spec:
                template:
                  spec:
                    restartPolicy: Never
                    serviceAccountName: cloudflare-dns
                    containers:
                      - name: curl
                        image: curlimages/curl:8.7.1
                        env:
                          - name: CF_ZONE_ID
                            valueFrom:
                              secretKeyRef:
                                name: mail-dns-secrets
                                key: zone-id
                          - name: CF_TOKEN
                            valueFrom:
                              secretKeyRef:
                                name: mail-dns-secrets
                                key: api-token
                        command: ["/bin/sh"]
                        args:
                          - -c
                          - |
                            curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records" \
                              -H "Authorization: Bearer $CF_TOKEN" \
                              -H "Content-Type: application/json" \
                              -d '{"type":"CNAME","name":"mta-sts","content":"{{ .spec.mailHostname }}","ttl":300,"proxied":false,"comment":"MTA-STS CNAME"}' && echo "mta-sts CNAME OK"
            - apiVersion: batch/v1
              kind: Job
              metadata:
                name: dns-txt-dkim-rsa-{{ .spec.domain }}
                namespace: crossplane-system
              spec:
                template:
                  spec:
                    restartPolicy: Never
                    serviceAccountName: cloudflare-dns
                    containers:
                      - name: curl
                        image: curlimages/curl:8.7.1
                        env:
                          - name: CF_ZONE_ID
                            valueFrom:
                              secretKeyRef:
                                name: mail-dns-secrets
                                key: zone-id
                          - name: CF_TOKEN
                            valueFrom:
                              secretKeyRef:
                                name: mail-dns-secrets
                                key: api-token
                          - name: DKIM_RSA
                            valueFrom:
                              secretKeyRef:
                                name: mail-dns-secrets
                                key: dkim-rsa
                        command: ["/bin/sh"]
                        args:
                          - -c
                          - |
                            curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records" \
                              -H "Authorization: Bearer $CF_TOKEN" \
                              -H "Content-Type: application/json" \
                              -d '{"type":"TXT","name":"{{ .spec.dkimRsaSelector }}._domainkey","content":"'"$DKIM_RSA"'","ttl":300,"proxied":false,"comment":"DKIM RSA key"}' && echo "DKIM RSA TXT OK"
