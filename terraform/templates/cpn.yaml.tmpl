# Disable default CNI so we can install Cilium later
cluster:
  network:
    cni:
      name: none
  apiServer:
    extraArgs:
      bind-address: 0.0.0.0
      advertise-address: ${node_ip}
    certSANs:
      - 127.0.0.1
      - ${node_ip}      # node private IP
      - ${lb_ip}        # LB private IP
      - ${lb_ip_public} # LB public IP
  etcd:
    advertisedSubnets:
      - 10.0.1.0/24
  externalCloudProvider:
    enabled: true
  proxy:
    disabled: true
  allowSchedulingOnControlPlanes: true

# Add all IPs into Talos API cert SANs
machine:
  certSANs:
    - 127.0.0.1
    - ${node_ip}
    - ${lb_ip}
    - ${lb_ip_public}
  sysctls:
    net.core.somaxconn: 65535
    net.core.netdev_max_backlog: 4096
  systemDiskEncryption:
    state:
      provider: luks2
      options:
        - no_read_workqueue
        - no_write_workqueue
      keys:
        - nodeID: {}
          slot: 0
    ephemeral:
      provider: luks2
      options:
        - no_read_workqueue
        - no_write_workqueue
      keys:
        - nodeID: {}
          slot: 0
  time:
    servers:
      - ntp1.hetzner.de
      - ntp2.hetzner.com
      - ntp3.hetzner.net
      - time.cloudflare.com
  features:
    kubePrism:
      enabled: true
      port: 7445
    kubernetesTalosAPIAccess:
      enabled: true
      allowedRoles:
        - os:reader
      allowedKubernetesNamespaces:
        - kube-system